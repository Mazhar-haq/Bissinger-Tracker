<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bissinger's Herald Square | Truffle Tracker</title>
    <style>
        :root {
            --bissingers-brown: #3d2b1f; 
            --bissingers-gold: #c5a059;  
            --bissingers-cream: #f9f6f2;
            --primary: var(--bissingers-brown);
            --secondary: #5d4037;
            --accent: var(--bissingers-gold);
            --success: #4a6741;
            --danger: #9e2a2b;
            --light: #f4eee8;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Optima', 'Palatino', 'Segoe UI', serif;
            padding: 15px;
            background: var(--light);
            color: var(--bissingers-brown);
            line-height: 1.5;
        }

        /* Header Styling */
        .header {
            background: var(--bissingers-brown);
            color: var(--bissingers-gold);
            padding: 25px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-bottom: 3px solid var(--bissingers-gold);
        }

        .header h1 { 
            font-size: 1.6rem; 
            margin-bottom: 5px; 
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 300;
        }

        /* Tabbed Navigation */
        .floor-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: #e0dcd8;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: var(--bissingers-brown);
            color: var(--bissingers-gold);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .floor-view {
            display: none;
        }

        .floor-view.active {
            display: block;
        }

        /* Card Styling */
        .card {
            background: var(--white);
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(61, 43, 31, 0.1);
            border: 1px solid rgba(197, 160, 89, 0.2);
        }

        .date-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--bissingers-brown);
            text-transform: uppercase;
        }

        input, select {
            padding: 10px;
            border: 1px solid #dcdcdc;
            border-radius: 2px;
            font-size: 1rem;
            width: 100%;
        }

        /* AI Scanner UI */
        .scanner-section {
            background: var(--bissingers-cream);
            border: 2px dashed var(--bissingers-gold);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .loading-spinner {
            display: none;
            margin: 10px auto;
            border: 4px solid rgba(0,0,0,0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--bissingers-gold);
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Table UI */
        .table-container { overflow-x: auto; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: var(--bissingers-brown); color: var(--bissingers-gold); }
        th { padding: 12px; text-align: left; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }

        .btn-row-scan {
            background: var(--bissingers-gold);
            color: var(--bissingers-brown);
            border: 1px solid var(--bissingers-brown);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .pm-cell { display: flex; align-items: center; gap: 8px; }

        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #e0dcd8; margin-bottom: 15px; padding: 10px; }
            td { padding-left: 50%; text-align: right; position: relative; min-height: 40px; display: flex; align-items: center; justify-content: flex-end; }
            td:before { content: attr(data-label); position: absolute; left: 10px; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; }
            td.flavor-name { display: block; text-align: center; padding: 12px; font-weight: bold; background: var(--bissingers-cream); margin-bottom: 10px; }
            td.flavor-name:before { content: ""; }
        }

        .calculated { font-weight: bold; }
        .error { color: var(--danger); }
        
        .btn-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .btn { padding: 12px; border-radius: 2px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; }
        .btn-save { background: var(--bissingers-brown); color: var(--bissingers-gold); border: 1px solid var(--bissingers-gold); }
        .btn-clear { background: #f8f8f8; color: #666; border: 1px solid #ddd; }
        .btn-ai { background: var(--bissingers-gold); color: var(--bissingers-brown); width: 100%; border: 1px solid var(--bissingers-brown); }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bissingers-brown); color: var(--bissingers-gold); padding: 12px 24px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    </style>
</head>
<body onload="init()">

    <div id="toast" class="toast">Action Complete</div>

    <div class="header">
        <h1>Bissinger's Truffle Tracker</h1>
        <p id="displayDate">Herald Square Inventory</p>
    </div>

    <!-- Global Info -->
    <div class="card">
        <div class="date-grid">
            <div class="input-group">
                <label>Date</label>
                <input type="date" id="trackingDate" onchange="updateDateDisplay(); saveData();">
            </div>
            <div class="input-group">
                <label>Opening MOD</label>
                <select id="openingMod" onchange="saveData()">
                    <option value="">Select...</option>
                    <option>Tom</option><option>Arin</option><option>Czar</option><option>Faith</option><option>Gully</option>
                </select>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-save" onclick="lockAM()">Lock AM Counts</button>
            <button class="btn btn-clear" onclick="clearAll()">Reset All</button>
        </div>
    </div>

    <!-- Floor Selector Tabs -->
    <div class="floor-tabs">
        <button class="tab-btn active" id="btn-f6" onclick="switchFloor('f6')">6th Floor</button>
        <button class="tab-btn" id="btn-f1" onclick="switchFloor('f1')">1st Floor</button>
    </div>

    <!-- Hidden Cameras -->
    <input type="file" id="globalCamera" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(event)">
    <input type="file" id="rowCamera" accept="image/*" capture="environment" style="display: none;" onchange="handleRowImageUpload(event)">

    <!-- 6th Floor View -->
    <div id="f6-view" class="floor-view active">
        <div class="card scanner-section">
            <h3 style="font-size: 0.8rem; margin-bottom: 10px; text-transform: uppercase;">6th Floor Batch Scan</h3>
            <div class="loading-spinner" id="scannerLoading"></div>
            <button class="btn btn-ai" onclick="document.getElementById('globalCamera').click()">ðŸ“· Scan whole case</button>
        </div>
        <div class="card">
            <input type="text" placeholder="Filter 6th Floor..." onkeyup="filterList(this, 'f6Body')" style="margin-bottom: 15px;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Flavor</th><th>AM</th><th>PM (Scan)</th><th>Sold</th><th>Refill</th><th>End</th></tr>
                    </thead>
                    <tbody id="f6Body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 1st Floor View -->
    <div id="f1-view" class="floor-view">
        <div class="card scanner-section">
            <h3 style="font-size: 0.8rem; margin-bottom: 10px; text-transform: uppercase;">1st Floor Batch Scan</h3>
            <div class="loading-spinner" id="scannerLoading1"></div>
            <button class="btn btn-ai" onclick="document.getElementById('globalCamera').click()">ðŸ“· Scan whole case</button>
        </div>
        <div class="card">
            <input type="text" placeholder="Filter 1st Floor..." onkeyup="filterList(this, 'f1Body')" style="margin-bottom: 15px;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Flavor</th><th>AM</th><th>PM (Scan)</th><th>Sold</th><th>Refill</th><th>End</th></tr>
                    </thead>
                    <tbody id="f1Body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "";
        const f6List = ["Birthday Cake Truffle", "Wedding Cake Truffle", "Root Beer Float Truffle", "Milk Chocolate Raspberry Cream", "Dark Chocolate Candy Cane", "Dark Raspberry Truffle", "Creme Brulee Truffle", "Tiramisu Truffle", "Pineapple Upside Down Cake Truffle", "Red Velvet Cake Truffle", "Irish Cream Truffle", "Chocolate Souffle Truffle", "White Euro Truffle", "White Russian Truffle", "Chocolate Milk Shake Truffle", "Dark Chocolate Caramel Macchiato Truffle", "German Chocolate Truffle", "Dark Chocolate Cherry Cordials", "Milk Swiss Chocolate Truffle", "Dark Swiss Chocolate Truffle", "Dark Sea Salt Caramel Truffle", "Strawberry Truffle", "Strawberry Cheese Cake Truffle", "Pistachio Crown Truffle", "Italian Espresso Truffle", "Dark Chocolate Caramel", "Fresh Mint Truffle", "Dark Creme Mints", "Milk Sea Salt Caramel", "Dark Cinnamon Almond Caramel", "Milk Chocolate Swiss Pecan Cream", "Milk Vanilla Dreams", "French Vanilla B", "Milk Chocolate English Almond Toffee", "Dark Chocolate English Almond Toffee", "Dark Lemon Creme", "Raspberry Caramel Jewel"];
        const f1List = ["Birthday Cake Truffle", "Wedding Cake Truffle", "White Euro Truffle", "Dark Chocolate Sea Salt Caramel", "White Chocolate Christmas Cookie Truffle", "Dark Chocolate Candy Cane", "White Chocolate Eggnog", "Milk Chocolate Caramel Fudge Brownie", "Milk Chocolate Peanut Butter", "Milk Chocolate French Salt Caramel", "Cherry Cordials", "Milk Chocolate Swiss Pecan Creme"];

        let currentFloor = 'f6';
        let currentRowId = null;

        function init() {
            const dateInput = document.getElementById('trackingDate');
            if (!dateInput.value) dateInput.valueAsDate = new Date();
            updateDateDisplay();
            renderRows(f6List, 'f6Body', 'f6');
            renderRows(f1List, 'f1Body', 'f1');
            loadData();
        }

        function switchFloor(floor) {
            currentFloor = floor;
            document.querySelectorAll('.floor-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`${floor}-view`).classList.add('active');
            document.getElementById(`btn-${floor}`).classList.add('active');
        }

        function renderRows(list, containerId, prefix) {
            const container = document.getElementById(containerId);
            list.forEach((name, i) => {
                const id = `${prefix}_${i}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="flavor-name">${name}</td>
                    <td data-label="AM"><input type="number" id="${id}_am" oninput="calc('${id}')" placeholder="0"></td>
                    <td data-label="PM">
                        <div class="pm-cell">
                            <input type="number" id="${id}_pm" oninput="calc('${id}')" placeholder="0">
                            <button class="btn-row-scan" onclick="triggerRowScan('${id}', '${name}')">ðŸ“· Scan</button>
                            <div class="loading-spinner" id="${id}_loading" style="margin:0;"></div>
                        </div>
                    </td>
                    <td data-label="Sold" class="calculated" id="${id}_sold">0</td>
                    <td data-label="Refill"><input type="number" id="${id}_refill" oninput="calc('${id}')" placeholder="0"></td>
                    <td data-label="End" class="calculated" id="${id}_end">0</td>
                `;
                container.appendChild(row);
            });
        }

        function triggerRowScan(id, flavor) {
            currentRowId = { id, flavor };
            document.getElementById('rowCamera').click();
        }

        async function handleRowImageUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentRowId) return;
            const loader = document.getElementById(`${currentRowId.id}_loading`);
            loader.style.display = 'block';
            try {
                const base64 = await toBase64(file);
                const count = await scanSingleFlavor(base64.split(',')[1], currentRowId.flavor);
                if (count !== null) {
                    document.getElementById(`${currentRowId.id}_pm`).value = count;
                    calc(currentRowId.id);
                    showToast(`Updated ${currentRowId.flavor}`);
                }
            } catch (e) { showToast("Row scan failed"); }
            finally { loader.style.display = 'none'; currentRowId = null; }
        }

        async function scanSingleFlavor(base64, flavor) {
            const prompt = `Identify counts for the truffle flavor: "${flavor}". Return ONLY a number.`;
            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }] };
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', body: JSON.stringify(payload) });
            const data = await resp.json();
            const text = data.candidates[0].content.parts[0].text.trim();
            const num = parseInt(text.replace(/\D/g,''));
            return isNaN(num) ? null : num;
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const loader = currentFloor === 'f6' ? document.getElementById('scannerLoading') : document.getElementById('scannerLoading1');
            loader.style.display = 'block';
            try {
                const base64 = await toBase64(file);
                const results = await scanTrufflePlate(base64.split(',')[1]);
                applyAIScanResults(results);
                showToast(`${currentFloor.toUpperCase()} Batch Scan Complete`);
            } catch (e) { showToast("Batch scan failed"); }
            finally { loader.style.display = 'none'; }
        }

        async function scanTrufflePlate(base64) {
            const list = currentFloor === 'f6' ? f6List : f1List;
            const prompt = `Identify counts for: ${list.join(", ")}. Respond ONLY JSON: {"results": [{"flavor": "Name", "count": 5}]}`;
            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }], generationConfig: { responseMimeType: "application/json" } };
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', body: JSON.stringify(payload) });
            const data = await resp.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        function applyAIScanResults(data) {
            (data.results || []).forEach(item => {
                const list = currentFloor === 'f6' ? f6List : f1List;
                const idx = list.indexOf(item.flavor);
                if (idx !== -1) {
                    document.getElementById(`${currentFloor}_${idx}_pm`).value = item.count;
                    calc(`${currentFloor}_${idx}`);
                }
            });
            saveData();
        }

        function toBase64(file) { return new Promise(r => { const reader = new FileReader(); reader.onload = () => r(reader.result); reader.readAsDataURL(file); }); }

        function calc(id) {
            const am = parseInt(document.getElementById(`${id}_am`).value) || 0;
            const pm = parseInt(document.getElementById(`${id}_pm`).value) || 0;
            const refill = parseInt(document.getElementById(`${id}_refill`).value) || 0;
            const sold = am - pm;
            const soldEl = document.getElementById(`${id}_sold`);
            soldEl.textContent = sold;
            soldEl.className = sold < 0 ? 'calculated error' : 'calculated';
            document.getElementById(`${id}_end`).textContent = pm + refill;
            saveData();
        }

        function saveData() {
            const getVals = (p, list) => list.map((_, i) => ({
                am: document.getElementById(`${p}_${i}_am`).value,
                pm: document.getElementById(`${p}_${i}_pm`).value,
                ref: document.getElementById(`${p}_${i}_refill`).value,
                locked: document.getElementById(`${p}_${i}_am`).disabled
            }));
            const data = { date: document.getElementById('trackingDate').value, open: document.getElementById('openingMod').value, f6: getVals('f6', f6List), f1: getVals('f1', f1List) };
            localStorage.setItem('truffle_tabbed_v1', JSON.stringify(data));
        }

        function loadData() {
            const raw = localStorage.getItem('truffle_tabbed_v1');
            if (!raw) return;
            const data = JSON.parse(raw);
            document.getElementById('trackingDate').value = data.date;
            document.getElementById('openingMod').value = data.open;
            updateDateDisplay();
            const setVals = (p, items) => items.forEach((item, i) => {
                const id = `${p}_${i}`;
                if(!document.getElementById(`${id}_am`)) return;
                document.getElementById(`${id}_am`).value = item.am;
                document.getElementById(`${id}_pm`).value = item.pm;
                document.getElementById(`${id}_refill`).value = item.ref;
                if(item.locked) document.getElementById(`${id}_am`).disabled = true;
                calc(id);
            });
            if(data.f6) setVals('f6', data.f6);
            if(data.f1) setVals('f1', data.f1);
        }

        function updateDateDisplay() {
            const d = new Date(document.getElementById('trackingDate').value);
            document.getElementById('displayDate').textContent = d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
        }

        function lockAM() {
            if(!confirm("Lock morning counts?")) return;
            document.querySelectorAll('input[id$="_am"]').forEach(el => el.disabled = true);
            saveData();
            showToast("Morning counts locked");
        }

        function clearAll() { if(!confirm("Clear all data?")) return; localStorage.clear(); location.reload(); }

        function filterList(input, bodyId) {
            const term = input.value.toLowerCase();
            const rows = document.getElementById(bodyId).getElementsByTagName('tr');
            for (let row of rows) {
                const name = row.querySelector('.flavor-name').textContent.toLowerCase();
                row.style.display = name.includes(term) ? "" : "none";
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2500);
        }
    </script>
</body>
</html>
