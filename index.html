<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bissinger's Herald Square Truffle Tracker</title>
    <style>
        :root {
            --bissingers-brown: #3d2b1f; 
            --bissingers-gold: #c5a059;  
            --bissingers-cream: #f9f6f2;
            --primary: var(--bissingers-brown);
            --accent: var(--bissingers-gold);
            --success: #4a6741;
            --danger: #9e2a2b;
            --info: #2c3e50;
            --light: #f4eee8;
            --white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Optima', 'Palatino', 'Segoe UI', serif; padding: 10px; background: var(--light); color: var(--bissingers-brown); padding-bottom: 220px; }

        .header { background: var(--bissingers-brown); color: var(--bissingers-gold); padding: 20px 10px; border-radius: 4px; margin-bottom: 15px; text-align: center; border-bottom: 3px solid var(--bissingers-gold); position: relative; }
        .header h1 { font-size: 1.2rem; letter-spacing: 1px; text-transform: uppercase; font-weight: 300; margin-bottom: 5px; }
        
        .settings-btn { position: absolute; right: 10px; top: 10px; background: none; border: none; color: var(--bissingers-gold); cursor: pointer; font-size: 1.2rem; }

        /* AI Vision Zone */
        .ai-zone { background: var(--white); padding: 15px; border-radius: 4px; margin-bottom: 15px; border: 1px dashed var(--bissingers-gold); text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-btn { background: var(--info); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin: 0 auto; font-size: 0.8rem; }

        .card { background: var(--white); padding: 15px; border-radius: 4px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(61, 43, 31, 0.1); border: 1px solid rgba(197, 160, 89, 0.2); }
        
        .input-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 600px) { .input-grid { grid-template-columns: repeat(3, 1fr); } }
        
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        .input-group label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        input, select { padding: 8px; border: 1px solid #dcdcdc; border-radius: 2px; width: 100%; font-size: 0.9rem; }

        .floor-tabs { display: flex; gap: 8px; margin-bottom: 15px; position: sticky; top: 0; z-index: 100; background: var(--light); padding: 10px 0; }
        .tab-btn { flex: 1; padding: 12px; background: #e0dcd8; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.75rem; color: #666; transition: 0.3s; }
        .tab-btn.active { background: var(--bissingers-brown); color: var(--bissingers-gold); }

        /* Show/Hide floor logic */
        .floor-view { display: none; }
        .floor-view.active { display: block; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background: var(--bissingers-brown); color: var(--bissingers-gold); padding: 8px 4px; font-size: 0.6rem; text-transform: uppercase; }
        td { padding: 8px 4px; border-bottom: 1px solid #f0f0f0; text-align: center; font-size: 0.85rem; }
        td:first-child { text-align: left; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; }
        .count-input { width: 45px; text-align: center; padding: 4px; border: 1px solid #eee; }
        .count-input:disabled { background: #f9f9f9; color: #999; border: none; }

        .sold-text { color: var(--success); font-weight: bold; }
        .end-text { font-weight: bold; }
        .low-stock { color: var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .summary-footer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bissingers-brown); color: var(--bissingers-gold); padding: 15px; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 -4px 10px rgba(0,0,0,0.3); }
        .summary-item { text-align: center; }
        .summary-val { font-size: 1.2rem; font-weight: bold; display: block; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 350px; text-align: center; }
        .modal-btn { display: block; width: 100%; padding: 12px; margin: 8px 0; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }

        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 4000; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--bissingers-gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--bissingers-brown); color: var(--bissingers-gold); padding: 10px 20px; border-radius: 4px; opacity: 0; transition: 0.3s; z-index: 1001; }

        @media print {
            .floor-tabs, .ai-zone, .summary-footer, .settings-btn, button { display: none !important; }
            body { padding: 0; background: white; }
            .card { box-shadow: none; border: 1px solid #ccc; }
            .floor-view { display: block !important; }
        }
    </style>
</head>
<body onload="init()">

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top:15px; font-weight:bold; color:var(--bissingers-brown);">AI analyzing truffles...</p>
    </div>

    <div id="toast" class="toast">Action Complete</div>

    <!-- API Key Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--bissingers-brown)">OpenRouter Config</h3>
            <p style="font-size: 0.75rem; margin: 10px 0; color: #666;">Key is stored only in your browser.</p>
            <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..." style="margin-bottom: 15px;">
            <button class="modal-btn" style="background:var(--bissingers-brown); color:var(--bissingers-gold);" onclick="saveSettings()">Save Key</button>
            <button class="modal-btn" style="background:#eee;" onclick="closeSettings()">Cancel</button>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">Report Generation</h3>
            <button class="modal-btn" style="background: var(--info); color: white;" onclick="generateReport('am')">Copy Morning (AM) Report</button>
            <button class="modal-btn" style="background: var(--bissingers-brown); color: var(--bissingers-gold);" onclick="generateReport('pm')">Copy Evening (PM) Report</button>
            <button class="modal-btn" style="background: #eee;" onclick="closeReport()">Cancel</button>
        </div>
    </div>

    <div class="header">
        <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
        <h1>Bissinger's Truffle Tracker</h1>
        <p id="displayDate" style="font-size: 0.8rem; opacity: 0.8;"></p>
    </div>

    <!-- Management Card -->
    <div class="card">
        <div class="input-grid">
            <div class="input-group">
                <label>Date</label>
                <input type="date" id="trackingDate" onchange="updateDateDisplay(); saveData();">
            </div>
            <div class="input-group">
                <label>Opening MOD</label>
                <select id="openingMod" onchange="saveData()">
                    <option value="">Select...</option>
                    <option>Tom</option><option>Arin</option><option>Czar</option><option>Faith</option><option>Gully</option><option>Associate</option>
                </select>
            </div>
            <div class="input-group">
                <label>Closing MOD</label>
                <select id="closingMod" onchange="saveData()">
                    <option value="">Select...</option>
                    <option>Tom</option><option>Arin</option><option>Czar</option><option>Faith</option><option>Gully</option><option>Associate</option>
                </select>
            </div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 15px;">
            <button id="lockAmBtn" style="flex: 1; padding: 10px; background: var(--bissingers-gold); border: none; font-weight: bold; border-radius: 4px; cursor: pointer;" onclick="lockAM()">Lock AM</button>
            <button style="flex: 1; padding: 10px; background: var(--info); color: white; border: none; font-weight: bold; border-radius: 4px;" onclick="openReport()">üìã Text Report</button>
            <button style="flex: 1; padding: 10px; background: var(--success); color: white; border: none; font-weight: bold; border-radius: 4px;" onclick="window.print()">üñ®Ô∏è PDF</button>
        </div>
    </div>

    <!-- AI Scan Section -->
    <div class="ai-zone">
        <input type="file" id="casePhoto" accept="image/*" style="display:none" onchange="handleVision()">
        <button class="ai-btn" onclick="document.getElementById('casePhoto').click()">
            üì∏ Scan Case
        </button>
        <p style="font-size: 0.6rem; color: #888; margin-top: 5px;">Snap a photo to auto-fill counts</p>
    </div>

    <div class="floor-tabs">
        <button class="tab-btn active" id="btn-f6" onclick="switchFloor('f6')">6th Floor Case</button>
        <button class="tab-btn" id="btn-f1" onclick="switchFloor('f1')">1st Floor Case</button>
    </div>

    <!-- 6th Floor -->
    <div id="f6-view" class="floor-view active">
        <div class="card" style="padding: 5px;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40%;">Flavor</th>
                            <th>AM</th>
                            <th>Refill</th>
                            <th>PM</th>
                            <th>Sold</th>
                            <th>End</th>
                        </tr>
                    </thead>
                    <tbody id="f6Body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 1st Floor -->
    <div id="f1-view" class="floor-view">
        <div class="card" style="padding: 5px;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40%;">Flavor</th>
                            <th>AM</th>
                            <th>Refill</th>
                            <th>PM</th>
                            <th>Sold</th>
                            <th>End</th>
                        </tr>
                    </thead>
                    <tbody id="f1Body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="summary-footer">
        <div class="summary-item">
            <span style="font-size: 0.6rem;">F6 STOCK</span>
            <span class="summary-val" id="total-f6">0</span>
        </div>
        <div class="summary-item">
            <span style="font-size: 0.6rem;">F1 STOCK</span>
            <span class="summary-val" id="total-f1">0</span>
        </div>
        <div class="summary-item">
            <span style="font-size: 0.6rem;">GRAND TOTAL</span>
            <span class="summary-val" id="total-grand" style="color:white; border-bottom: 2px solid var(--bissingers-gold);">0</span>
        </div>
    </div>

    <script>
        const f6List = [
            "BIRTHDAY CAKE TRUFFLE", "WEDDING CAKE TRUFFLE", "MILK CHOCOLATE CARAMEL CHEESECAKE TRUFFLE", 
            "STRAWBERRY TRUFFLE", "ROOT BEER FLOAT TRUFFLE", "STRAWBERRY CHEESECAKE TRUFFLE", 
            "CR√àME BR√õL√âE TRUFFLE", "TIRAMISU TRUFFLE", "DARK SEA SALT CARAMEL TRUFFLE", 
            "RED VELVET CAKE TRUFFLE", "IRISH CREAM TRUFFLE", "DARK CHOCOLATE CANDY CANE TRUFFLE", 
            "CHOCOLATE SOUFFL√â TRUFFLE", "WHITE EURO TRUFFLE", "WHITE RUSSIAN TRUFFLE", 
            "CHOCOLATE MILKSHAKE TRUFFLE", "MILK CHOCOLATE CARAMEL FUDGE BROWNIE TRUFFLE", 
            "DARK CHOCOLATE CARAMEL MACCHIATO TRUFFLE", "GERMAN CHOCOLATE TRUFFLE", 
            "RASPBERRY CARAMEL JEWEL", "MILK SWISS CHOCOLATE TRUFFLE", "DARK SWISS CHOCOLATE TRUFFLE", 
            "PINEAPPLE UPSIDE DOWN TRUFFLE", "MILK CHOCOLATE RASPBERRY CREAM", 
            "MILK CHOCOLATE ORANGE CREAM", "DARK CHOCOLATE MAPLE PECAN CREAM", 
            "PISTACHIO CROWN TRUFFLE", "ITALIAN ESPRESSO TRUFFLE", "DARK CHOCOLATE CARAMEL", 
            "FRESH MINT TRUFFLE", "DARK CREAM MINT", "MILK SEA SALT CARAMEL", 
            "DARK CINNAMON ALMOND CARAMEL", "MILK CHOCOLATE SWISS PECAN CREAM", 
            "MILK VANILLA DREAM", "FRENCH VANILLA \"B\"", "MILK CHOCOLATE ENGLISH ALMOND TOFFEE", 
            "DARK CHOCOLATE ENGLISH ALMOND TOFFEE", "LEMON TEARDROP TRUFFLE"
        ];
        
        const f1List = [
            "BIRTHDAY CAKE TRUFFLE", "WEDDING CAKE TRUFFLE", "WHITE EURO TRUFFLE", 
            "DARK CHOCOLATE SEA SALT CARAMEL TRUFFLE", "MILK CHOCOLATE TIRAMISU TRUFFLE",
            "FRESH MINT TRUFFLE", "DARK CHOCOLATE FRENCH VANILLA \"B\"", 
            "DARK CHOCOLATE RASPBERRY CARAMEL JEWEL", "PISTACHIO CROWN TRUFFLE", 
            "MILK CHOCOLATE CARAMEL FUDGE BROWNIE TRUFFLE", "MILK CHOCOLATE FRENCH SEA SALT CARAMEL", 
            "MILK CHOCOLATE SWISS PECAN CREAM"
        ];

        function init() {
            const dateInput = document.getElementById('trackingDate');
            if (!dateInput.value) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }
            updateDateDisplay();
            renderRows(f6List, 'f6Body', 'f6');
            renderRows(f1List, 'f1Body', 'f1');
            loadData();
        }

        function renderRows(list, containerId, prefix) {
            const container = document.getElementById(containerId);
            list.forEach((name, i) => {
                const id = `${prefix}_${i}`;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${name}</td>
                    <td><input type="number" id="${id}_am" class="count-input" onkeydown="handleTab(event, '${prefix}', ${i}, 'am')" oninput="calc('${id}')"></td>
                    <td><input type="number" id="${id}_refill" class="count-input" onkeydown="handleTab(event, '${prefix}', ${i}, 'refill')" oninput="calc('${id}')"></td>
                    <td><input type="number" id="${id}_pm" class="count-input" onkeydown="handleTab(event, '${prefix}', ${i}, 'pm')" oninput="calc('${id}')"></td>
                    <td id="${id}_sold" class="sold-text">0</td>
                    <td id="${id}_end" class="end-text">0</td>
                `;
                container.appendChild(tr);
            });
        }

        /**
         * Custom navigation logic to move focus DOWN instead of RIGHT
         */
        function handleTab(e, prefix, currentIndex, column) {
            // Handle Tab (9) or Enter (13)
            if (e.keyCode === 9 || e.keyCode === 13) {
                const list = prefix === 'f6' ? f6List : f1List;
                const nextIndex = e.shiftKey ? currentIndex - 1 : currentIndex + 1;
                
                // If there's a next/previous row in this column
                if (nextIndex >= 0 && nextIndex < list.length) {
                    e.preventDefault(); // Stop standard tab behavior
                    const nextInput = document.getElementById(`${prefix}_${nextIndex}_${column}`);
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select(); // Highlight content for easier typing
                    }
                }
            }
        }

        function calc(id) {
            const am = parseInt(document.getElementById(`${id}_am`).value) || 0;
            const ref = parseInt(document.getElementById(`${id}_refill`).value) || 0;
            const pmVal = document.getElementById(`${id}_pm`).value;
            const pm = parseInt(pmVal) || 0;

            const endEl = document.getElementById(`${id}_end`);
            const soldEl = document.getElementById(`${id}_sold`);

            const end = (pmVal === "") ? (am + ref) : pm;
            endEl.textContent = end;

            if (pmVal !== "") {
                soldEl.textContent = Math.max(0, (am + ref) - pm);
            } else {
                soldEl.textContent = "0";
            }

            if (end > 0 && end < 5) endEl.classList.add('low-stock');
            else endEl.classList.remove('low-stock');

            updateTotals();
            saveData();
        }

        function updateTotals() {
            const getSum = (prefix, list) => list.reduce((acc, _, i) => {
                const el = document.getElementById(`${prefix}_${i}_end`);
                return acc + (el ? parseInt(el.textContent) || 0 : 0);
            }, 0);
            const f6 = getSum('f6', f6List);
            const f1 = getSum('f1', f1List);
            document.getElementById('total-f6').textContent = f6;
            document.getElementById('total-f1').textContent = f1;
            document.getElementById('total-grand').textContent = f6 + f1;
        }

        function switchFloor(f) {
            document.querySelectorAll('.floor-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`${f}-view`).classList.add('active');
            document.getElementById(`btn-${f}`).classList.add('active');
        }

        function updateDateDisplay() {
            const dInput = document.getElementById('trackingDate').value;
            if (!dInput) return;
            const parts = dInput.split('-');
            const d = new Date(parts[0], parts[1] - 1, parts[2]);
            document.getElementById('displayDate').textContent = d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function lockAM() {
            document.querySelectorAll('input[id$="_am"]').forEach(i => i.disabled = true);
            const btn = document.getElementById('lockAmBtn');
            btn.textContent = "AM Locked";
            btn.disabled = true;
            btn.style.opacity = "0.5";
            saveData();
            showToast("Morning counts locked.");
        }

        function saveData() {
            const data = {
                date: document.getElementById('trackingDate').value,
                oMod: document.getElementById('openingMod').value,
                cMod: document.getElementById('closingMod').value,
                amLocked: document.getElementById('lockAmBtn').disabled,
                f6: f6List.map((_, i) => ({
                    am: document.getElementById(`f6_${i}_am`).value,
                    ref: document.getElementById(`f6_${i}_refill`).value,
                    pm: document.getElementById(`f6_${i}_pm`).value
                })),
                f1: f1List.map((_, i) => ({
                    am: document.getElementById(`f1_${i}_am`).value,
                    ref: document.getElementById(`f1_${i}_refill`).value,
                    pm: document.getElementById(`f1_${i}_pm`).value
                }))
            };
            localStorage.setItem('biss_truffle_full_v1', JSON.stringify(data));
        }

        function loadData() {
            const raw = localStorage.getItem('biss_truffle_full_v1');
            if (!raw) return;
            const data = JSON.parse(raw);
            document.getElementById('trackingDate').value = data.date;
            document.getElementById('openingMod').value = data.oMod;
            document.getElementById('closingMod').value = data.cMod;
            
            const fill = (prefix, arr) => arr.forEach((row, i) => {
                const id = `${prefix}_${i}`;
                const amIn = document.getElementById(`${id}_am`);
                const refIn = document.getElementById(`${id}_refill`);
                const pmIn = document.getElementById(`${id}_pm`);
                
                if (amIn) amIn.value = row.am;
                if (refIn) refIn.value = row.ref;
                if (pmIn) pmIn.value = row.pm;
                
                if (data.amLocked && amIn) amIn.disabled = true;
                calc(id);
            });
            fill('f6', data.f6);
            fill('f1', data.f1);
            if (data.amLocked) {
                const btn = document.getElementById('lockAmBtn');
                btn.textContent = "AM Locked";
                btn.disabled = true;
                btn.style.opacity = "0.5";
            }
            updateDateDisplay();
        }

        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
        function saveSettings() {
            localStorage.setItem('or_api_key', document.getElementById('apiKeyInput').value);
            closeSettings();
            showToast("API Key Saved");
        }

        async function handleVision() {
            const key = localStorage.getItem('or_api_key');
            if (!key) { alert("Please set your OpenRouter API key in settings!"); return; }
            const file = document.getElementById('casePhoto').files[0];
            if (!file) return;

            document.getElementById('loadingOverlay').style.display = 'flex';
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                try {
                    const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "nvidia/nemotron-4-340b-instruct", 
                            messages: [{
                                role: "user",
                                content: [
                                    { type: "text", text: "Analyze the truffle case image. Return JSON mapping names to counts." },
                                    { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                                ]
                            }]
                        })
                    });
                    const result = await resp.json();
                    alert("Analysis complete. Review counts.");
                } catch(e) { alert("AI Error: " + e.message); }
                finally { document.getElementById('loadingOverlay').style.display = 'none'; }
            };
        }

        function openReport() { document.getElementById('reportModal').style.display = 'flex'; }
        function closeReport() { document.getElementById('reportModal').style.display = 'none'; }
        function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.opacity = 1; setTimeout(()=>t.style.opacity=0, 2500); }

        function generateReport(type) {
            const date = document.getElementById('displayDate').textContent;
            const mod = type === 'am' ? document.getElementById('openingMod').value : document.getElementById('closingMod').value;
            let report = `BISSINGER'S ${type.toUpperCase()} REPORT\nDate: ${date}\nMOD: ${mod || 'N/A'}\n\n`;

            const build = (title, list, prefix) => {
                report += `--- ${title} FLOOR ---\n`;
                list.forEach((name, i) => {
                    const id = `${prefix}_${i}`;
                    const am = document.getElementById(`${id}_am`).value || 0;
                    const pm = document.getElementById(`${id}_pm`).value || 0;
                    const sold = document.getElementById(`${id}_sold`).textContent;
                    if (type === 'am' && am > 0) report += `${name}: AM Start ${am}\n`;
                    if (type === 'pm' && (pm > 0 || sold > 0)) report += `${name}: Sold ${sold} | End ${pm}\n`;
                });
                report += `\n`;
            };

            build("6TH", f6List, "f6");
            build("1ST", f1List, "f1");
            
            const dummy = document.createElement("textarea");
            document.body.appendChild(dummy);
            dummy.value = report; dummy.select();
            document.execCommand("copy");
            document.body.removeChild(dummy);
            closeReport();
            showToast("Report copied to clipboard!");
        }
    </script>
</body>
</html>
